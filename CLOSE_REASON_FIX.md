# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π

## –ü—Ä–æ–±–ª–µ–º–∞

–£–±—ã—Ç–æ—á–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –ø–æ–º–µ—á–∞–ª–∏—Å—å –∫–∞–∫ `take_profit` –≤–º–µ—Å—Ç–æ `stop_loss`.

## –ü—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã

1. **–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ**: –í `test_trades_ui.py` –ø—Ä–∏—á–∏–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∞—Å—å —Å–ª—É—á–∞–π–Ω–æ (`'test'` –∏–ª–∏ `'take_profit'`), –Ω–µ —É—á–∏—Ç—ã–≤–∞—è —Ä–µ–∞–ª—å–Ω—ã–π PnL.

2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏**: –ú–µ—Ç–æ–¥ `close_virtual_position()` –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏—á–∏–Ω—ã –∑–∞–∫—Ä—ã—Ç–∏—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.

3. **–ü–æ–∑–∏—Ü–∏–∏ –±–µ–∑ —É—Ä–æ–≤–Ω–µ–π**: –ü–æ–∑–∏—Ü–∏–∏ –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö `stop_loss` –∏ `take_profit` –º–æ–≥–ª–∏ –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø—Ä–∏—á–∏–Ω–æ–π.

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `_check_virtual_position_conditions()`

–ü–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –ø—Ä–∏—á–∏–Ω—ã `take_profit` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:
- –î–ª—è BUY: —Ü–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞
- –î–ª—è SELL: —Ü–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∏–∂–µ —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞

–ï—Å–ª–∏ —É—Å–ª–æ–≤–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–∏—á–∏–Ω–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `stop_loss`.

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `close_virtual_position()`

–ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:
- –ï—Å–ª–∏ `close_reason == "take_profit"` –∏ `pnl_net < 0` ‚Üí –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `stop_loss`
- –ï—Å–ª–∏ `close_reason == "stop_loss"` –∏ —Ü–µ–Ω–∞ –¥–æ—Å—Ç–∏–≥–ª–∞ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞ ‚Üí –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `take_profit`

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

–í—Å–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å –ø—Ä–∏—á–∏–Ω—ã –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã:
- ‚úÖ –£–±—ã—Ç–æ—á–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `stop_loss`
- ‚úÖ –ü—Ä–∏–±—ã–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `take_profit`
- ‚úÖ –°–¥–µ–ª–∫–∏ –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `manual`

## –°–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–î–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ –ë–î —Å–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç:

```bash
python3.11 src/fix_close_reasons.py
```

–°–∫—Ä–∏–ø—Ç:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –∑–∞–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø—Ä–∏—á–∏–Ω—É –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ PnL –∏ —Ü–µ–Ω
- –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏
- –í—ã–≤–æ–¥–∏—Ç –æ—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö

## –ü—Ä–æ–≤–µ—Ä–∫–∞

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:

```python
# –ù–∞–π—Ç–∏ —É–±—ã—Ç–æ—á–Ω—ã–µ —Å–¥–µ–ª–∫–∏ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø—Ä–∏—á–∏–Ω–æ–π
SELECT id, symbol, side, entry_price, exit_price, realized_pnl, close_reason
FROM virtual_positions
WHERE status = 'closed' 
  AND realized_pnl < 0 
  AND close_reason = 'take_profit'
```

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ç–∞–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ.

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏

–°–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–∏–ª —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏:
- #76: XRPUSDT LONG - —É–±—ã—Ç–æ–∫, –±—ã–ª–æ `take_profit` ‚Üí –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ `stop_loss`
- #78: ETHUSDT SHORT - —É–±—ã—Ç–æ–∫, –±—ã–ª–æ `take_profit` ‚Üí –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ `stop_loss`
- #80: BTCUSDT SHORT - —É–±—ã—Ç–æ–∫, –±—ã–ª–æ `take_profit` ‚Üí –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ `stop_loss`

