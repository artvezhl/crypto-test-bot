name: Deploy Trading Bot

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install SSHpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Test server connection
        run: |
          echo "üîç Testing server connection..."
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "pwd && whoami && mkdir -p trading-bot"

      - name: Deploy application
        run: |
          set -e
          echo "üì¶ Starting deployment..."
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è
          cat > deploy.sh << 'SCRIPT'
          set -e
          
          echo "üîÑ Updating code in ~/trading-bot..."
          cd ~/trading-bot
          ls -la
          
          echo "üêç Setting up Python environment..."
          python3 -m venv venv --clear
          source venv/bin/activate
          
          echo "üìö Installing dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt
          
          echo "üîß (Re)starting bot..."
          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å –µ—Å–ª–∏ –µ—Å—Ç—å, –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π
          pm2 delete trading-bot 2>/dev/null || true
          pm2 start main.py --name "trading-bot" --interpreter venv/bin/python
          pm2 save
          
          echo "‚úÖ Deployment completed successfully!"
          echo "üìä Bot status:"
          pm2 status
          SCRIPT
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
          echo "üì§ Copying project files..."
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -o StrictHostKeyChecking=no -r . ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:trading-bot/
          
          # –ö–æ–ø–∏—Ä—É–µ–º –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è
          echo "üöÄ Running deployment script..."
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -o StrictHostKeyChecking=no deploy.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:trading-bot/
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "cd trading-bot && chmod +x deploy.sh && ./deploy.sh"

      - name: Cleanup
        run: rm -f deploy.sh