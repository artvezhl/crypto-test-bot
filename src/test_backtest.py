#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º—ã –±—ç–∫—Ç–µ—Å—Ç–∏–Ω–≥–∞.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python src/test_backtest.py
"""

import logging
from datetime import datetime, timedelta
from backtester import BacktestEngine


def setup_logging():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"""
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )


def run_simple_backtest():
    """–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Å—Ç–æ–≥–æ –±—ç–∫—Ç–µ—Å—Ç–∞"""
    print("\n")
    print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
    print("‚ïë                     –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –°–ò–°–¢–ï–ú–´ –ë–≠–ö–¢–ï–°–¢–ò–ù–ì–ê                          ‚ïë")
    print("‚ïë                     –°–∏–º—É–ª—è—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö                 ‚ïë")
    print("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")
    print("\n")
    
    # –°–æ–∑–¥–∞–µ–º –¥–≤–∏–∂–æ–∫ –±—ç–∫—Ç–µ—Å—Ç–∏–Ω–≥–∞
    print("üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è BacktestEngine...")
    engine = BacktestEngine()
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±—ç–∫—Ç–µ—Å—Ç–∞
    print("\nüìã –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±—ç–∫—Ç–µ—Å—Ç–∞...")
    
    # –ü–µ—Ä–∏–æ–¥: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π (–∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ—Å—Ç)
    end_date = datetime.now()
    start_date = end_date - timedelta(days=7)
    
    # –¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã
    symbols = ['BTCUSDT', 'ETHUSDT']
    
    # –¢–∞–π–º—Ñ—Ä–µ–π–º
    interval = '15'  # 15-–º–∏–Ω—É—Ç–Ω—ã–µ —Å–≤–µ—á–∏
    
    # –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
    initial_balance = 10000.0
    
    print(f"   üìÖ –ü–µ—Ä–∏–æ–¥: {start_date.strftime('%Y-%m-%d')} - {end_date.strftime('%Y-%m-%d')}")
    print(f"   üìä –°–∏–º–≤–æ–ª—ã: {', '.join(symbols)}")
    print(f"   ‚è±Ô∏è  –¢–∞–π–º—Ñ—Ä–µ–π–º: {interval} –º–∏–Ω—É—Ç")
    print(f"   üí∞ –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: ${initial_balance:.2f}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±—ç–∫—Ç–µ—Å—Ç
    print("\nüöÄ –ó–∞–ø—É—Å–∫ –±—ç–∫—Ç–µ—Å—Ç–∞...\n")
    
    results = engine.run_backtest(
        symbols=symbols,
        interval=interval,
        start_date=start_date,
        end_date=end_date,
        initial_balance=initial_balance
    )
    
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    if results:
        print("\n" + "=" * 80)
        print("‚úÖ –ë–≠–ö–¢–ï–°–¢ –ó–ê–í–ï–†–®–Å–ù –£–°–ü–ï–®–ù–û")
        print("=" * 80)
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        roi = results.get('roi_percent', 0)
        if roi > 0:
            print(f"\nüéâ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–∏–±—ã–ª—å–Ω–∞! ROI: +{roi:.2f}%")
        elif roi < 0:
            print(f"\n‚ö†Ô∏è  –°—Ç—Ä–∞—Ç–µ–≥–∏—è —É–±—ã—Ç–æ—á–Ω–∞! ROI: {roi:.2f}%")
        else:
            print(f"\n‚û°Ô∏è  –°—Ç—Ä–∞—Ç–µ–≥–∏—è –≤ –Ω—É–ª–µ. ROI: {roi:.2f}%")
        
        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        print("\nüí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:")
        
        win_rate = results.get('win_rate', 0)
        if win_rate < 40:
            print("   ‚ö†Ô∏è  Win Rate –Ω–∏–∑–∫–∏–π (<40%) - —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è")
        elif win_rate > 60:
            print("   ‚úÖ Win Rate —Ö–æ—Ä–æ—à–∏–π (>60%) - —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–∞—è")
        else:
            print("   ‚û°Ô∏è  Win Rate —Å—Ä–µ–¥–Ω–∏–π (40-60%) - –µ—Å—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è")
        
        max_dd = results.get('max_drawdown', 0)
        if max_dd > 20:
            print(f"   ‚ö†Ô∏è  Max Drawdown –≤—ã—Å–æ–∫–∏–π ({max_dd:.1f}%) - –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫")
        elif max_dd < 10:
            print(f"   ‚úÖ Max Drawdown –Ω–∏–∑–∫–∏–π ({max_dd:.1f}%) - –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π —Ä–∏—Å–∫")
        else:
            print(f"   ‚û°Ô∏è  Max Drawdown —É–º–µ—Ä–µ–Ω–Ω—ã–π ({max_dd:.1f}%) - –ø—Ä–∏–µ–º–ª–µ–º—ã–π —Ä–∏—Å–∫")
        
        total_trades = results.get('total_trades', 0)
        if total_trades < 5:
            print(f"   ‚ö†Ô∏è  –ú–∞–ª–æ —Å–¥–µ–ª–æ–∫ ({total_trades}) - —É–≤–µ–ª–∏—á—å—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏")
        elif total_trades > 50:
            print(f"   ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–¥–µ–ª–æ–∫ ({total_trades}) - —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º–æ")
        else:
            print(f"   ‚û°Ô∏è  –£–º–µ—Ä–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫ ({total_trades}) - –ø—Ä–∏–µ–º–ª–µ–º–æ")
        
    else:
        print("\n" + "=" * 80)
        print("‚ùå –ë–≠–ö–¢–ï–°–¢ –ù–ï –ó–ê–í–ï–†–®–Å–ù")
        print("=" * 80)
        print("\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –æ–± –æ—à–∏–±–∫–µ")
    
    return results


def run_custom_backtest():
    """–ó–∞–ø—É—Å–∫ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –±—ç–∫—Ç–µ—Å—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏"""
    print("\n" + "=" * 80)
    print("üéØ –†–ê–°–®–ò–†–ï–ù–ù–´–ô –ë–≠–ö–¢–ï–°–¢")
    print("=" * 80)
    
    engine = BacktestEngine()
    
    # –ë–æ–ª–µ–µ –¥–ª–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥
    end_date = datetime.now()
    start_date = end_date - timedelta(days=30)
    
    # –ë–æ–ª—å—à–µ —Å–∏–º–≤–æ–ª–æ–≤
    symbols = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT']
    
    # –î—Ä—É–≥–æ–π —Ç–∞–π–º—Ñ—Ä–µ–π–º
    interval = '60'  # 1-—á–∞—Å–æ–≤—ã–µ —Å–≤–µ—á–∏
    
    # –ë–æ–ª—å—à–∏–π –Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
    initial_balance = 50000.0
    
    print(f"\nüìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:")
    print(f"   üìÖ –ü–µ—Ä–∏–æ–¥: 30 –¥–Ω–µ–π")
    print(f"   üìä –°–∏–º–≤–æ–ª—ã: {len(symbols)} –ø–∞—Ä")
    print(f"   ‚è±Ô∏è  –¢–∞–π–º—Ñ—Ä–µ–π–º: 1 —á–∞—Å")
    print(f"   üí∞ –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: ${initial_balance:.2f}")
    
    print("\n‚è≥ –≠—Ç–æ –∑–∞–π–º–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —Ç–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã—Ö –±–æ–ª—å—à–µ...")
    print("   (–º–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ç–µ—Å—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)\n")
    
    # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –±—ç–∫—Ç–µ—Å—Ç–∞:
    # results = engine.run_backtest(
    #     symbols=symbols,
    #     interval=interval,
    #     start_date=start_date,
    #     end_date=end_date,
    #     initial_balance=initial_balance
    # )
    
    print("   ‚ö†Ô∏è  –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –±—ç–∫—Ç–µ—Å—Ç –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω")
    print("   üìù –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∫–æ–¥ –≤ test_backtest.py –¥–ª—è –∑–∞–ø—É—Å–∫–∞")


def compare_strategies():
    """–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏"""
    print("\n" + "=" * 80)
    print("üìä –°–†–ê–í–ù–ï–ù–ò–ï –°–¢–†–ê–¢–ï–ì–ò–ô")
    print("=" * 80)
    
    print("\nüí° –î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –º–æ–∂–Ω–æ:")
    print("   1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±—ç–∫—Ç–µ—Å—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ min_confidence")
    print("   2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±—ç–∫—Ç–µ—Å—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ stop_loss/take_profit")
    print("   3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±—ç–∫—Ç–µ—Å—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏")
    print("   4. –°—Ä–∞–≤–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –≤—ã–±—Ä–∞—Ç—å –ª—É—á—à—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é")
    
    print("\nüìù –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:")
    print("""
    # –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∞—è
    engine1 = BacktestEngine()
    engine1.min_confidence = 0.8
    engine1.stop_loss_percent = 1.5
    results1 = engine1.run_backtest(...)
    
    # –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è
    engine2 = BacktestEngine()
    engine2.min_confidence = 0.6
    engine2.stop_loss_percent = 3.0
    results2 = engine2.run_backtest(...)
    
    # –°—Ä–∞–≤–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    if results1['roi_percent'] > results2['roi_percent']:
        print("–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ª—É—á—à–µ!")
    else:
        print("–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ª—É—á—à–µ!")
    """)


if __name__ == "__main__":
    setup_logging()
    
    try:
        # –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç
        results = run_simple_backtest()
        
        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        # run_custom_backtest()
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
        # compare_strategies()
        
        print("\n" + "=" * 80)
        print("‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
        print("=" * 80)
        print("\nüí° –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:")
        print("   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ –≤—ã–≤–æ–¥–µ –≤—ã—à–µ")
        print("   2. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –ë–î")
        print("   3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
        print("   4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ–ª–µ–µ –¥–ª–∏—Ç–µ–ª—å–Ω—ã–π –±—ç–∫—Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏")
        print("\n")
        
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è  –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        print(f"\n\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –±—ç–∫—Ç–µ—Å—Ç–∞: {e}")
        import traceback
        traceback.print_exc()


